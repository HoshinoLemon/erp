<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sky.mapper.PurchaseOrderItemMapper">

    <insert id="batchInsert" parameterType="java.util.List">
        insert into purchase_order_item (
        order_id, product_id, product_name, quantity,
        unit_price, total_price
        ) values
        <foreach collection="list" item="item" separator=",">
            (
            #{item.orderId}, #{item.productId}, #{item.productName},
            #{item.quantity}, #{item.unitPrice}, #{item.totalPrice}
            )
        </foreach>
    </insert>

    <insert id="insert" parameterType="com.sky.entity.PurchaseOrderItem" useGeneratedKeys="true" keyProperty="id">
        insert into purchase_order_item (
            order_id, product_id, product_name, quantity,
            unit_price, total_price
        ) values (
                     #{orderId}, #{productId}, #{productName},
                     #{quantity}, #{unitPrice}, #{totalPrice}
                 )
    </insert>

    <select id="listByOrderId" parameterType="java.lang.Long" resultType="com.sky.entity.PurchaseOrderItem">
        select
            id, order_id, product_id, product_name,
            quantity, unit_price, total_price
        from purchase_order_item
        where order_id = #{orderId}
    </select>

    <select id="getById" parameterType="java.lang.Long" resultType="com.sky.entity.PurchaseOrderItem">
        select
            id, order_id, product_id, product_name,
            quantity, unit_price, total_price
        from purchase_order_item
        where id = #{id}
    </select>

    <!-- 在PurchaseOrderItemMapper.xml中添加以下内容 -->
    <select id="sumBySupplier" resultType="com.sky.vo.SupplierPurchaseVO">
        select
            po.supplier_id as supplierId,
            s.name as supplierName,
            sum(poi.total_price) as totalAmount
        from purchase_order_item poi
                 left join purchase_order po on poi.order_id = po.id
                 left join supplier s on po.supplier_id = s.id
        where po.create_time between #{start} and #{end} and po.status = 2
        group by po.supplier_id, s.name
        order by totalAmount desc
    </select>

    <select id="pageQuery" parameterType="com.sky.dto.PurchaseOrderItemQueryDTO" resultType="com.sky.entity.PurchaseOrderItem">
        SELECT
        id,
        purchase_order_id,
        product_id,
        product_name,
        unit_price,
        quantity,
        total_price
        FROM purchase_order_item
        <where>
            <!-- 按采购单ID筛选（必传，查询指定采购单的明细） -->
            <if test="purchaseOrderId != null">
                AND purchase_order_id = #{purchaseOrderId}
            </if>
            <!-- 按商品名称模糊查询（可选） -->
            <if test="productName != null and productName != ''">
                AND product_name LIKE CONCAT('%', #{productName}, '%')
            </if>
        </where>
        ORDER BY id ASC
    </select>

</mapper>