<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sky.mapper.SalesOrderItemMapper">

    <insert id="insert" parameterType="com.sky.entity.SalesOrderItem" useGeneratedKeys="true" keyProperty="id">
        insert into sales_order_item (
            order_id, product_id, product_name, quantity,
            unit_price, total_price
        ) values (
                     #{orderId}, #{productId}, #{productName}, #{quantity},
                     #{unitPrice}, #{totalPrice}
                 )
    </insert>

    <insert id="batchInsert" parameterType="java.util.List">
        insert into sales_order_item (
        order_id, product_id, product_name, quantity,
        unit_price, total_price
        ) values
        <foreach collection="list" item="item" separator=",">
            (
            #{item.orderId}, #{item.productId}, #{item.productName},
            #{item.quantity}, #{item.unitPrice}, #{item.totalPrice}
            )
        </foreach>
    </insert>

    <select id="listByOrderId" parameterType="java.lang.Long" resultType="com.sky.entity.SalesOrderItem">
        select
            id, order_id, product_id, product_name, quantity,
            unit_price, total_price
        from sales_order_item
        where order_id = #{orderId}
        order by id asc
    </select>

    <select id="sumByProduct" resultType="com.sky.vo.ProductSalesVO">
        SELECT
        p.id AS productId,
        p.name AS productName,
        SUM(soi.quantity) AS totalQuantity,
        SUM(soi.total_price) AS totalAmount
        FROM sales_order_item soi
        JOIN sales_order so ON soi.order_id = so.id
        JOIN product p ON soi.product_id = p.id
        WHERE so.create_time BETWEEN #{start} AND #{end}
        GROUP BY p.id, p.name
        ORDER BY totalAmount DESC
    </select>

</mapper>
